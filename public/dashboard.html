<script>
let walletBalance = 0;
const user = "defaultUser"; // Later, replace with real login

// Fetch wallet on load
async function loadWallet() {
  try {
    const res = await fetch(`/api/wallet?user=${user}`);
    const data = await res.json();
    walletBalance = data.wallet;
    updateBalanceUI();
  } catch (err) {
    console.log("Wallet fetch error", err);
  }
}

function updateBalanceUI() {
  document.getElementById("walletBalance").innerText =
    "UGX " + walletBalance.toLocaleString();
}

async function deposit(channel) {
  const amount = parseInt(document.getElementById("depositAmount").value);
  if (!amount || amount < 2000) {
    alert("Minimum deposit is 2000 UGX");
    return;
  }

  const phone = prompt(`Enter your ${channel} phone number (07XXXXXXXX):`);
  if (!phone) return;

  try {
    const res = await fetch("/api/deposit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user, amount, phone, channel })
    });
    const data = await res.json();

    if (data.redirect_url) {
      walletBalance = data.wallet;
      updateBalanceUI();
      alert("Deposit credited! Redirecting to Pesapal sandbox...");
      window.location.href = data.redirect_url;
    } else {
      alert(data.error || "Deposit failed");
    }
  } catch (err) {
    alert("Network error");
  }
}

// Initialize wallet on page load
loadWallet();
  </script>
